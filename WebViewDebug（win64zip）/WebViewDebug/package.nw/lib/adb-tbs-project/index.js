"use strict";function e(e,t,n){let r={type:e,message:t,detail:n,device:JSON.stringify(global.analysis)};T.post({url:"https://x5.tencent.com/tbs/tbsstudio/report",form:r},function(e,t,n){})}function t(t,r){A("INFO","client listDevices begin "),k.listDevices().then(e=>{A("INFO","client listDevices:"+JSON.stringify(e)),B=e&&e.length>0?e[0]:null,A("INFO","client listDevices currDevice :"+JSON.stringify(B)),t(e)},t=>{A("INFO","client listDevices currDevice error :"+t),e("adbconnect","adbkit getdevices error",t.message),"mac"==w.name&&n(),k.resetAdb().then(()=>{A("INFO","client listDevices resetAdb:"+t)}),r(null)})}function n(){A("INFO","setmacvendor begin");let t=[];`system_profiler SPUSBDataType`;C("system_profiler SPUSBDataType",{},function(n,r,o){if(n)return A("ERROR","client getMACVender error: "+n),void e("getMACVender","check mac vendor command error ",n.message);let i=r.match(/Vendor ID: 0x[0-9a-zA-Z]*/gi)||[];t=i.map(function(e){return(e.match(/0x[0-9a-zA-Z]*/gi)||[""])[0]}),A("INFO","setmacvendor: "+t.join(",")),e("adbconnect","setmacvendor",t.join(","));let c=S.getDataPath()+"/adb_usb.ini";D.readFile(c,function(e,n){let r="";console.log(e),!e&&n&&(r=n.toString("utf8"));let o=t.filter(function(e){return r.indexOf(e)<0});o.length&&D.writeFile(c,o.join("\r\n")+"\r\n",{flag:"a"},function(e){if(e)return console.log(e),!1;let t="cat "+c.replace(/\ /gi,"\\ ")+" > ~/.android/adb_usb.ini";C(t,{},function(e,t,n){if(e)return console.log(e),!1})})})})}function r(t){A("INFO","client killServer begin "),k.kill().then(e=>{A("INFO","client killServer result :"+JSON.stringify(e)),t(e)},n=>{A("INFO","client killServer result error :"+n),e("adbconnect","adbkit killServer error",n.message),t(null)})}function o(t,n){A("INFO","client usbServer begin "),k.usb(t).then(e=>{A("INFO","client usbServer serial("+t+"):"+JSON.stringify(e)),n(e)},r=>{A("INFO","client usbServer serial("+t+") error :"+r),e("adbconnect","adbkit usbServer serial("+t+") error",r.message),n(null)})}function i(t){function n(n,i){let c=null;n.on("data",function(e){if(i){let t=/mCurrentFocus(\W|\w|{|}|:)*\//.exec(e);e=t&&t.length>0?t[0]:e}let t=/\s\S{1,}.\S{1,}.\S{1,}\//.exec(e),n=t&&t.length>0?t[0]:"",r=n.search(/\s/),o=n.search(/\//),s=n.substring(r+1,o),l=s.split(" ");(s=l&&l.find(function(e){return/^(\w+\.+)+(\w+)$/.test(e)}))&&(c=N.getAppInfo(s))}).on("error",function(e){A("ERROR","client getTopApp error :"+e)}).on("end",function(){return c?(x=c,A("INFO","client getTopApp focusAppPkg: "+JSON.stringify(c)),c.name||e("getTopApp","get top app not in tbs app list",c.scheme),t(Object.assign({},{ret:0},{appInfo:c}))):!c&&o<3?(A("INFO","client getTopApp try again shellCommand dealCount : "+o),void r()):(A("INFO","client getTopApp no focusAppPkg"),t({ret:-2}))})}function r(){if(o++,!(B&&o<=3))return A("ERROR","client getTopApp shellCommand no devices"),t({ret:-1});k.shell(B.id,i[o-1]).then(e=>{n(e,3==o)},n=>{if(e("getTopApp","get top app shell error, "+i[o-1],n.message),A("ERROR","client getTopApp shellCommand error commands["+(o-1)+"]:"+n),o>=3)return t({ret:-2});r()})}let o=0,i=["dumpsys window windows | grep -E 'mCurrentFocus'","dumpsys window windows | grep -E 'mFocusedApp'","dumpsys window windows"];r()}function c(t){function n(n){A("INFO","client checkQBInspector checkPid pid: "+n),k.shell(B.id,r).then(r=>{r.on("data",function(e){(e=new String(e)).split(/[\f\n\r\t\v]/gi).map(function(t){if(t.indexOf("webview_devtools_remote_"+n)>-1){if(i.length>3)return;i=e}})}).on("error",function(n){e("checkQBInspector","check pid parse output data error ",n.message),A("ERROR","client checkQBInspector checkPid error : "+n),t(!1)}).on("end",function(){A("INFO","client checkQBInspector checkPid end : "+(i.length>0)),t(i.length>0)})},n=>(e("checkQBInspector","check pid shell command error ",n.message),A("ERROR","client checkQBInspector checkPid error : "+n),t(!1)))}let r="cat /proc/net/unix",o="",i="";!function(r){k.shell(B.id,r).then(r=>{r.on("data",function(e){let t=(e=new String(e)).split(/[\f\n\r\t\v]/gi).find(function(e){return e.indexOf("com.tencent.mtt")>-1}),r=t&&t.replace(/[\s]{2,}/gi," ").split(" ");r&&r.length>1&&"com.tencent.mtt"==r.pop().trim()&&n(o=r[1])}).on("error",function(n){e("checkQBInspector","check qb focus parse output data error ",n.message),A("ERROR","client checkQBInspector checkQBFocus error: "+n),t(!1)}).on("end",function(){o||t(!1)})},n=>(A("ERROR","client checkQBInspector checkQBFocus error: "+n),e("checkQBInspector","check qb focus shell command error ",n.message),t(!1)))}("ps")}function s(t){k.shell(B.id,"am broadcast -a android.intent.action.TBS_DEBUG -d tbs_inspector:test").then((e,t)=>{});let n=!1,r=setTimeout(function(){n=!0,A("ERROR","client checkTBSInspector timeout "),t(!1)},5e3);k.openLogcat(B.id).then(e=>{var o=e;e.on("entry",function(e){new RegExp("test x5_core success").test(e.message)&&(clearTimeout(r),o.end(),A("INFO","client checkTBSInspector result: true"),!n&&t(!0))})},function(r){e("checkTBSInspector","get log error ",r.message),A("ERROR","client checkTBSInspector error : "+r),!n&&t(!1)})}function l(e){A("INFO","client checkInspector scheme:"+x.scheme),"com.tencent.mtt"===x.scheme?c(e):s(e)}function a(t){A("INFO","client startApp pkgName:"+t);let n="monkey -p "+t+" -c android.intent.category.LAUNCHER 1 ";return new Promise(function(t,r){k.shell(B.id,n).then(e=>{t()},t=>{e("startApp","startApp error ",t.message),A("ERROR","client startApp error: "+t)})})}function u(t){A("INFO","client killApp pkgName:"+t);let n="am force-stop "+t;return new Promise((t,r)=>{k.shell(B.id,n).then(e=>{t()},t=>{e("killApp","killApp error ",t.message),A("ERROR","client killApp error: "+t)})})}function p(e,t){return A("INFO","client downloadApk begin"),new Promise(function(n,r){function o(){n()}D.unlink(e.tmpDest,t=>{A("ERROR","client downloadApk unlink "+e.tmpDest+" error: "+t)}),D.unlink(e.dest,t=>{A("ERROR","client downloadApk unlink "+e.dest+" error: "+t)});let i=0,c=0,s=D.createWriteStream(e.tmpDest);E.get(e.fileUrl,n=>{c=parseInt(n.headers["content-length"]||n.headers["x-goog-stored-content-length"],10),n.on("data",e=>{let n=(100*(i+=e.length)/c).toFixed(2);t({ret:0,code:2,data:n}),s.write(e)}).on("end",()=>{A("INFO","client downloadApk download success "),s.end(),D.renameSync(s.path,e.dest)})});s.on("finish",()=>{A("INFO","client downloadApk download finish "),s.close(o)})})}function d(t,n){return A("INFO","client debugApkInstall begin "),new Promise(function(r,o){k.uninstall(B.id,t.pkgName).then(function(){let o=!1,i=setTimeout(function(){return o=!0,A("ERROR","client debugApkInstall timeout "),n({ret:-1,code:4,msg:"debug install timeout"}),r()},6e4);A("INFO","client debugApkInstall uninstall success: "+t.pkgName),k.install(B.id,t.dest).then(function(e){return A("INFO","client debugApkInstall install msg: "+e),clearTimeout(i),null==e?(A("INFO","client debugApkInstall install success : "+t.dest),!o&&n({ret:0,code:4}),r()):(A("ERROR","client debugApkInstall install error : "+t.dest),!o&&n({ret:-1,code:4,msg:"debug install error"}),r())},t=>{e("install","install error ",t.message),A("ERROR","client install error: "+t)})},t=>{e("uninstall","uninstall error ",t.message),A("ERROR","client uninstall error: "+t)})})}function g(t,n){let r="pm list packages "+t;console.log(r),k.shell(B.id,r).then(function(e){A("INFO","client checkAppInstall success ");let t="";e.on("data",function(e){let n=new String(e).replace(/[\f\n\r\t\v]/gi,"");n&&(t=n),A("INFO","client checkAppInstall output : "+t)}).on("error",function(e){console.log(e),A("ERROR","client checkAppInstall error : "+e)}).on("end",function(){n({ret:t?0:-1})})},function(t){e("openInspector","open inspector shell command error ",t.message),A("ERROR","client openInspector error: "+t)})}function m(t,n){return A("INFO","client installTbsDemo begin"),new Promise(function(r,o){if("com.tencent.tbs"===t.pkgName){k.shell(B.id,"monkey -p com.tencent.tbs -c android.intent.category.LAUNCHER 1 ").then(function(t){let o=!1,i=setTimeout(function(){o=!0,A("INFO","client installTbsDemo timeout"),n({ret:-1,code:5}),r()},6e4);k.openLogcat(B.id).then(function(e){let t=e;e.on("entry",function(e){var c=new RegExp("TbsStudioClient is going to restartApplication"),s=new RegExp("com.tencent.tbs/app_tbs/core_unzip_tmp/tbs_jars_fusion_dex.dex");(c.test(e.message)||s.test(e.message))&&(t.end(),clearTimeout(i),A("INFO","client installTbsDemo success"),!o&&n({ret:0,code:5}),r())})},function(t){A("ERROR","client installTbsDemo error: "+t),e("installTbsDemo","open log error ",t.message),n({ret:-1,code:5}),r()})})}else n({ret:0,code:5}),r()})}function f(e){A("INFO","client installTbsApp begin ");var t={};let n=S.getDataPath();t="com.tencent.mtt"==x.scheme?{tmpDest:n+"/debugqb_tmp",dest:n+"/qb_demo.apk",fileUrl:"http://mcaredown.3g.qq.com/browser/tes/qqbrowser_android_inspector.apk",pkgName:"com.tencent.mtt"}:{tmpDest:n+"/debugtbs_tmp",dest:n+"/tbs_demo.apk",fileUrl:"http://mcaredown.3g.qq.com/browser/tes/tbs_blink_MainActivity_debug.apk",pkgName:"com.tencent.tbs"},u(x.scheme).then(function(){e({ret:0,code:1}),p(t,e).then(function(){e({ret:0,code:3,data:100}),d(t,e).then(function(){m(t,e).then(function(){})})})})}function h(){A("INFO","client openInspector begin ");k.shell(B.id,"am broadcast -a android.intent.action.TBS_DEBUG -d tbs_inspector:true").then(function(e){A("INFO","client openInspector success "),e.on("data",function(e){let t=new String(e).replace(/[\f\n\r\t\v]/gi,"");A("INFO","client openInspector output : "+t)}).on("error",function(e){A("ERROR","client openInspector error : "+e)}).on("end",function(){})},t=>{e("openInspector","open inspector shell command error ",t.message),A("ERROR","client openInspector error: "+t)})}function I(t){A("INFO","client getAndroidId begin ");let n="";let r=!1;var o=setTimeout(function(){!r&&t(n),r=!0},2e3);k.shell(B.id,"settings get secure android_id").then(e=>{e.on("data",function(e){let t=new String(e).replace(/[\f\n\r\t\v]/gi,"");A("INFO","client getAndroidId : "+t),n=t.length>5?t:""}).on("error",function(e){A("ERROR","client getAndroidId error : "+e)}).on("end",function(){!r&&t(n),r=!0,clearTimeout(o)})},o=>{e("getAndroidId","getAndroidId error ",o.message),A("ERROR","getAndroidId error: "+o),!r&&t(n),r=!0})}function R(t){let n="";k.shell(B.id,"getprop ro.product.model").then(e=>{e.on("data",function(e){n=new String(e).replace(/[\f\n\r\t\v]/gi,""),A("INFO","client getCurrentDeviceModel : "+n)}).on("error",function(e){A("ERROR","client getCurrentDeviceModel error : "+e)}).on("end",function(){t(n)})},n=>{e("getCurrentDeviceModel","getCurrentDeviceModel error ",n.message),A("ERROR","client getCurrentDeviceModel error :"+n),t(null)})}function O(t){let n="";k.shell(B.id,"getprop ro.build.version.release").then(e=>{e.on("data",function(e){n=new String(e).replace(/[\f\n\r\t\v]/gi,""),A("INFO","client getCurrentDeviceSystem : "+n)}).on("error",function(e){A("ERROR","client getCurrentDeviceSystem error : "+e)}).on("end",function(){t(n)})},n=>{e("getCurrentDeviceSystem","getCurrentDeviceSystem error ",n.message),A("ERROR","client getCurrentDeviceSystem error :"+n),t(null)})}function b(e){A("INFO","client tbs studio current version: "+F.version);let t={win:1,mac:5}[w.name]||1;if(A("INFO","client platform ("+w.name+") type: "+t),!F.version||!t)return e({ret:-1});let n={version:"v"+F.version,type:t};T.post({url:"https://x5.tencent.com/tbs/tbsstudio/checkVersion",form:n},function(t,n,r){if(A("INFO","client check tbs studio version : "+r),t||200!=n.statusCode)e({ret:-1,msg:"error"});else{var o=JSON.parse(r);if(0==o.code){let t=A.getLogDate()+"_"+o.data.version;A.isLogExist(t,n=>{n?e({ret:-1,msg:"error"}):(A("INFO",t,t),e({ret:0,data:o.data}))})}else e({ret:-1,msg:"error"})}})}let k=require("../adb-project"),v=require("../tbs-utils-project"),N=v.scheme,A=v.log,F=v.config,w=v.platform,S=require("../win-project"),D=require("fs"),E=require("http"),T=require("request"),y=require("path"),_=require("child_process"),C=_.exec,B={},x=null;module.exports={getDevices:t,killServer:r,usbServer:o,getTopApp:i,checkInspector:l,installTbsApp:f,checkAppInstall:g,openInspector:h,getAndroidId:I,killApp:u,startApp:a,checkVersion:b,getCurrentDeviceModel:R,getCurrentDeviceSystem:O,report:e};